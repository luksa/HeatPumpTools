<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Dependent Heating Curve Visualizer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        body { padding: 20px; }
        #chart { max-height: 600px; cursor: crosshair; }
        .header-container { position: relative; }
        .by-line {
            position: absolute;
            bottom: 0;
            right: 0;
            color: #6c757d;
        }
        @media (max-width: 576px) {
            .by-line { position: static; text-align: right; margin-top: 0.5rem; }
        }
        .share-buttons {
            margin-top: 1rem;
        }
        .share-buttons .btn {
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .narrow-input {
            max-width: 10ch;
        }
        .lwt-input-group {
            min-width: 320px;
        }
        #lwt-results p {
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .lwt-row {
            align-items: flex-start;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container mb-4">
            <h1 class="d-inline-block">Weather Dependent Heating Curve Visualizer</h1>
            <div class="by-line">
                By <a href="https://github.com/luksa" target="_blank">Marko Lukša</a>
            </div>
        </div>
        <p class="mb-4">Enter the two points for the curve.</p>
        
        <div class="row">
            <!-- Left column: curve inputs only -->
            <div class="col-md-4 order-md-1 order-2">
                <div id="curves-container" class="mb-4"></div>
                <button id="add-curve" class="btn btn-primary mb-4">Add Another Curve</button>
            </div>
            
            <!-- Right column: graph + LWT calculator + share -->
            <div class="col-md-8 order-md-2 order-1">
                <canvas id="chart" class="mb-4"></canvas>
                
                <!-- LWT Calculator – full width under the graph -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">What's my LWT at a given outdoor temperature?</h5>
                        <div class="row lwt-row">
                            <div class="col">
                                <div class="input-group lwt-input-group">
                                    <span class="input-group-text">Outdoor Temp</span>
                                    <input id="oat-input" type="number" step="1" class="form-control narrow-input" placeholder="e.g. 5">
                                    <span class="input-group-text">°C</span>
                                </div>
                            </div>
                            <div class="col" id="lwt-results">
                                <!-- Results will appear here, aligned to top -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Share box -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Share this curve</h5>
                        <div class="share-buttons">
                            <button id="copy-clipboard" class="btn btn-secondary">
                                <i class="fas fa-copy"></i> Copy Link
                            </button>
                        </div>
                        <small id="copy-feedback" class="text-success d-none">Link copied to clipboard!</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let curves = [];
        let chart;
        const DEFAULT_MIN_X = -10;
        const DEFAULT_MAX_X = 25;
        const DEFAULT_MIN_Y = 20;
        const DEFAULT_MAX_Y = 40;
        const EXTEND_PADDING_X = 5;
        const EXTEND_PADDING_Y = 5;
        const SEPARATOR = ',';

        function addCurve(data = {x1: -5, y1: 45, x2: 20, y2: 25}) {
            const container = document.getElementById('curves-container');
            const div = document.createElement('div');
            div.className = 'card mb-3';
            div.innerHTML = `
                <div class="card-body">
                    <h5 class="card-title">Curve</h5>
                    
                    <div class="mb-4">
                        <h6 class="fw-bold">Low Outdoor Temperature Point</h6>
                        <div class="row align-items-center">
                            <label class="col-sm-6 col-form-label text-sm-end">Outdoor Temp</label>
                            <div class="col-sm-6">
                                <div class="input-group">
                                    <input type="number" class="form-control narrow-input x1" value="${data.x1}" step="0.1">
                                    <span class="input-group-text">°C</span>
                                </div>
                            </div>
                        </div>
                        <div class="row align-items-center">
                            <label class="col-sm-6 col-form-label text-sm-end">Leaving Water Temp</label>
                            <div class="col-sm-6">
                                <div class="input-group">
                                    <input type="number" class="form-control narrow-input y1" value="${data.y1}" step="0.1">
                                    <span class="input-group-text">°C</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="fw-bold">High Outdoor Temperature Point</h6>
                        <div class="row align-items-center">
                            <label class="col-sm-6 col-form-label text-sm-end">Outdoor Temp</label>
                            <div class="col-sm-6">
                                <div class="input-group">
                                    <input type="number" class="form-control narrow-input x2" value="${data.x2}" step="0.1">
                                    <span class="input-group-text">°C</span>
                                </div>
                            </div>
                        </div>
                        <div class="row align-items-center">
                            <label class="col-sm-6 col-form-label text-sm-end">Leaving Water Temp</label>
                            <div class="col-sm-6">
                                <div class="input-group">
                                    <input type="number" class="form-control narrow-input y2" value="${data.y2}" step="0.1">
                                    <span class="input-group-text">°C</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-danger remove">Remove Curve</button>
                </div>
            `;
            container.appendChild(div);

            div.querySelectorAll('input').forEach(input => {
                input.addEventListener('change', updateAll);
            });

            div.querySelector('.remove').addEventListener('click', () => {
                div.remove();
                updateAll();
            });

            updateAll();
        }

        function updateAll() {
            const divs = document.querySelectorAll('#curves-container > .card');
            curves = [];
            divs.forEach((div, i) => {
                const x1 = parseFloat(div.querySelector('.x1').value);
                const y1 = parseFloat(div.querySelector('.y1').value);
                const x2 = parseFloat(div.querySelector('.x2').value);
                const y2 = parseFloat(div.querySelector('.y2').value);
                if (!isNaN(x1) && !isNaN(y1) && !isNaN(x2) && !isNaN(y2)) {
                    curves.push({x1, y1, x2, y2});
                }
                div.querySelector('.card-title').textContent = `Curve ${i + 1}`;
            });
            updateChart();
            updateURL();
            updateShareLinks();
        }

        function getLWTForCurve(curve, oat) {
            let points = [{x: curve.x1, y: curve.y1}, {x: curve.x2, y: curve.y2}].sort((a, b) => a.x - b.x);
            const left = points[0];
            const right = points[1];
            if (oat <= left.x) return left.y;
            if (oat >= right.x) return right.y;
            const slope = (right.y - left.y) / (right.x - left.x);
            return left.y + slope * (oat - left.x);
        }

        function updateChart() {
            if (chart) chart.destroy();
            const ctx = document.getElementById('chart').getContext('2d');

            let allX = [];
            let allY = [];
            curves.forEach(c => {
                allX.push(c.x1, c.x2);
                allY.push(c.y1, c.y2);
            });

            let minX = DEFAULT_MIN_X;
            let maxX = DEFAULT_MAX_X;
            if (allX.length > 0) {
                const actualMin = Math.min(...allX);
                const actualMax = Math.max(...allX);
                minX = Math.min(minX, actualMin - EXTEND_PADDING_X);
                maxX = Math.max(maxX, actualMax + EXTEND_PADDING_X);
            }
            const displayMinX = Math.floor(minX);
            const displayMaxX = Math.ceil(maxX);

            let minY = DEFAULT_MIN_Y;
            let maxY = DEFAULT_MAX_Y;
            if (allY.length > 0) {
                const actualMin = Math.min(...allY);
                const actualMax = Math.max(...allY);
                minY = Math.min(minY, actualMin - EXTEND_PADDING_Y);
                maxY = Math.max(maxY, actualMax + EXTEND_PADDING_Y);
            }
            const displayMinY = Math.floor(minY);
            const displayMaxY = Math.ceil(maxY);


            const datasets = curves.map((c, i) => {
                let points = [{x: c.x1, y: c.y1}, {x: c.x2, y: c.y2}].sort((a, b) => a.x - b.x);
                const leftPoint = points[0];
                const rightPoint = points[1];

                const data = [];

                for (let temp = displayMinX; temp <= Math.floor(leftPoint.x); temp++) {
                    data.push({x: temp, y: leftPoint.y});
                }

                data.push({x: leftPoint.x, y: leftPoint.y});

                const slopeStart = Math.ceil(leftPoint.x);
                const slopeEnd = Math.floor(rightPoint.x);
                for (let temp = slopeStart; temp < slopeEnd; temp++) {
                    const y = getLWTForCurve(c, temp);
                    data.push({x: temp, y: y});
                }

                data.push({x: rightPoint.x, y: rightPoint.y});

                for (let temp = Math.ceil(rightPoint.x); temp <= displayMaxX; temp++) {
                    data.push({x: temp, y: rightPoint.y});
                }

                return {
                    label: `Curve ${i + 1}`,
                    data: data,
                    borderColor: `hsl(${i * 137 % 360}, 70%, 50%)`,
                    backgroundColor: `hsl(${i * 137 % 360}, 70%, 50%)`,
                    fill: false,
                    tension: 0,
                    pointRadius: function(context) {
                        const value = context.parsed.x;
                        if (value === leftPoint.x || value === rightPoint.x) {
                            return 5;
                        }
                        return 0;
                    },
                    pointHoverRadius: function(context) {
                        const value = context.parsed.x;
                        if (value === leftPoint.x || value === rightPoint.x) {
                            return 8;
                        }
                        return 4;
                    },
                    pointBackgroundColor: `hsl(${i * 137 % 360}, 70%, 50%)`
                };
            });

            chart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            position: 'nearest',
                            caretPadding: 20,
                            padding: 12,
                            titleMarginBottom: 10,
                            bodySpacing: 6,
                            titleFont: { size: 15, weight: 'bold' },
                            bodyFont: { size: 14 },
                            callbacks: {
                                title: function(tooltipItems) {
                                    const rawX = tooltipItems[0].parsed.x;
                                    const roundedX = Math.round(rawX);
                                    return "Test me";
                                    //return `Outdoor Temp: ${roundedX} °C`;
                                },
                                label: function(context) {
                                    const curveIndex = context.datasetIndex;
                                    const curve = curves[curveIndex];
                                    const oat = Math.round(context.parsed.x);
                                    const lwt = getLWTForCurve(curve, oat);
                                    return `Curve ${curveIndex + 1}: LWT ${lwt.toFixed(1)} °C`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: { display: true, text: 'Outdoor Temperature (°C)' },
                            min: displayMinX,
                            max: displayMaxX,
                            ticks: { stepSize: 5 }
                        },
                        y: {
                            title: { display: true, text: 'Leaving Water Temperature (°C)' },
                            min: displayMinY,
                            max: displayMaxY,
                            ticks: { stepSize: 5 }
                        }
                    },
                    plugins: [{
                        id: 'crosshair',
                        afterDatasetsDraw: function(chartInstance) {
                            const tooltip = chartInstance.tooltip;
                            if (tooltip.opacity === 0) return;

                            const activeElements = tooltip.dataPoints;
                            if (!activeElements || activeElements.length === 0) return;

                            const ctx = chartInstance.ctx;
                            const x = activeElements[0].element.x;
                            const y = activeElements[0].element.y;
                            const chartArea = chartInstance.chartArea;

                            ctx.save();
                            ctx.setLineDash([6, 4]);
                            ctx.lineWidth = 1.5;
                            ctx.strokeStyle = 'rgba(80, 80, 80, 0.8)';

                            // Vertical line
                            ctx.beginPath();
                            ctx.moveTo(x, chartArea.top);
                            ctx.lineTo(x, chartArea.bottom);
                            ctx.stroke();

                            // Horizontal line (left to point)
                            ctx.beginPath();
                            ctx.moveTo(chartArea.left, y);
                            ctx.lineTo(x, y);
                            ctx.stroke();

                            ctx.restore();
                        }
                    }]
                }
            });
        }

        function updateURL() {
            const base = window.location.pathname;
            const queryParts = [];

            curves.forEach((curve, i) => {
                const value = `${curve.x1}${SEPARATOR}${curve.y1}${SEPARATOR}${curve.x2}${SEPARATOR}${curve.y2}`;
                queryParts.push(`curve${i + 1}=${value}`);
            });

            const oatInput = document.getElementById('oat-input');
            const oat = parseFloat(oatInput.value);
            if (!isNaN(oat)) {
                queryParts.push(`oat=${oat}`);
            }

            queryParts.sort();

            const newQuery = queryParts.join('&');
            const newUrl = newQuery ? `${base}?${newQuery}` : base;

            history.replaceState(null, '', newUrl);
        }

        function updateShareLinks() {
            const url = encodeURIComponent(window.location.href);
            const title = encodeURIComponent(document.title);
            document.getElementById('share-facebook').href = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
            document.getElementById('share-x').href = `https://twitter.com/intent/tweet?url=${url}&text=${title}`;
            document.getElementById('share-whatsapp').href = `https://wa.me/?text=${title}%20${url}`;
            document.getElementById('share-email').href = `mailto:?subject=${title}&body=Check out this heating curve:%20${url}`;
        }

        async function copyToClipboard() {
            try {
                await navigator.clipboard.writeText(window.location.href);
                const feedback = document.getElementById('copy-feedback');
                feedback.classList.remove('d-none');
                setTimeout(() => feedback.classList.add('d-none'), 3000);
            } catch (err) {
                alert('Failed to copy link. Please copy it manually from the address bar.');
            }
        }

        function loadFromURL() {
            const search = window.location.search.substring(1);
            if (!search) {
                addCurve();
                return;
            }
            const params = new URLSearchParams(search);
            const curveKeys = Array.from(params.keys()).filter(k => k.startsWith('curve')).sort();
            curveKeys.forEach(key => {
                const vals = params.get(key).split(SEPARATOR);
                if (vals.length === 4) {
                    const x1 = parseFloat(vals[0]);
                    const y1 = parseFloat(vals[1]);
                    const x2 = parseFloat(vals[2]);
                    const y2 = parseFloat(vals[3]);
                    if (!isNaN(x1) && !isNaN(y1) && !isNaN(x2) && !isNaN(y2)) {
                        addCurve({x1, y1, x2, y2});
                    }
                }
            });

            if (params.has('oat')) {
                const oat = parseFloat(params.get('oat'));
                if (!isNaN(oat)) {
                    document.getElementById('oat-input').value = oat;
                    calculateLWT(oat);
                }
            }

            if (curveKeys.length === 0) addCurve();
        }

        function calculateLWT(oat) {
            const results = document.getElementById('lwt-results');
            results.innerHTML = '';
            if (isNaN(oat)) return;
            curves.forEach((c, i) => {
                const lwt = getLWTForCurve(c, oat);
                const p = document.createElement('p');
                p.textContent = `Curve ${i + 1}: LWT = ${lwt.toFixed(2)} °C`;
                results.appendChild(p);
            });
        }

        window.addEventListener('load', () => {
            loadFromURL();
            updateShareLinks();
            document.getElementById('copy-clipboard').addEventListener('click', copyToClipboard);
        });

        document.getElementById('add-curve').addEventListener('click', () => addCurve());

        document.getElementById('oat-input').addEventListener('input', (e) => {
            const oat = parseFloat(e.target.value);
            calculateLWT(oat);
            updateURL();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>